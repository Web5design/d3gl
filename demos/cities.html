<!DOCTYPE html>
<html>
<head>
    <title>D3GL Space</title>
    <style type="text/css">
        body {
            background-color: #111;
            font: 20pt "Trebuchet MS","Helvetica Neue",sans-serif;
            color: #fff;
        }
        h1 {
            margin: 30px 20px 50px;
        }
        ul {
            list-style-type: none;
            float: left;
            margin-right: 70px;
        }
        li {
            text-align: center;
        }
        #globe {
        }
        .date-picker {
            height: 50px;
            width: 50px;
        }
        #prev {
        }
        #next {
        }
        #date {
            height: 50px;
            width: 50px;
            font-size: 14pt;
            color: #fff;
        }
    </style>
</head>
<body>

<h1>Earthquakes in the Past 30 Days</h1>
<ul id="controls">
    <li class="date-picker" id="prev">
    </li>
    <li id="date" month="11" day="2">
   Dec<br>2 
    </li>
    <li class="date-picker" id="next">
    </li>
</ul>

<script type="text/javascript" src="../js/jquery-1.8.2.js"></script>
<script type="text/javascript" src="../js/jquery.mousewheel.js"></script>
<script type="text/javascript" src="../js/d3.v2.js"></script>
<script type="text/javascript" src="../js/RequestAnimationFrame.js"></script>
<script type="text/javascript" src="../js/three.js"></script>
<script type="text/javascript" src="../js/d3gl.js"></script>
<!-- All scripts above are included here:
<script type="text/javascript" src="../js/d3gl.min.js"></script> -->

<script type="text/javascript">

var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function makeBars(data, colorScale, heightScale) {
    var globe = d3.gl.globe()
        .width(300).height(300)
        .texture("../img/earth-gray.png")
    
    var month = 11;
    var bars = globe.bars()
        .data(function(d) { return d['all']; })
        .id(function(d) { return d['id']; })
        .latitude(function(d){ return d['lat']; })
        .longitude(function(d){ return d['lon']; })
        .width(0.01)
        .height(function(d){ return 0; })
        .color(function(d){
            return colorScale(d['magnitude']);
        })
        .transition()
            .ease("sin")
            .duration(500)
            .height(function(d){
                return heightScale(d['magnitude']);
            });

    d3.select("body").append("div")
        .attr("id", "globe")
        .datum(data).call(globe);
    return bars;
}

function switchTimePeriod(bars, month, heightScale) {
    /*
    bars.data(function(d) {
        return d['2012'][month];
    });
    */
    bars.transition()
            .duration(500)
            .height(function(d) { return -0.01; })
            .data(function(data) { return data['2012'][month]; })
        .transition()
            .duration(500)
            .height(function(d) {
                return heightScale(d['MAGNITUDE']);
            });
}

function initControls() {
    $(".date-picker").click(function(evt) {
        evt.preventDefault();
        var display = $("#date");
        var month = parseInt(display.attr("month"));
        var day = parseInt(display.attr("day"));
        var date = new Date();
        date.setFullYear(2012, month, day);
        if($(this).attr("id")=="next") {
            if(month==11 && day==2) return;
            date.setDate(date.getDate() + 1); 
        } else {
            if(month==10 && day==2) return;
            date.setDate(date.getDate() - 1);
        }
        display.attr("month", date.getMonth());
        display.attr("day", date.getDate());
        display.html(months[date.getMonth()] + "<br>" + date.getDate());
    });
}

function renderGlobe() {
    var colorScale = d3.scale.quantile()
        .domain([0, 3, 4, 5, 6, 7, 8, 10])
        .range([
            "#ddff00", // minor
            "#fff000", // light
            "#ffcc00", // moderate
            "#ff5500", // strong
            "#ff2200", // major
            "#ff0000", // great
        ]);

    var heightScale = d3.scale.linear()
        .domain([0, 10])
        .range([0, 0.4]);

    var data, bars;
    $.get('../data/recent_earthquakes.json', function(d) {
        data = d;
        bars = makeBars(d, colorScale, heightScale);
    });
}

$(function(){
    initControls();
    renderGlobe();
    /*
    var painter = globe.paint(function(context, datum){
        context.beginPath();
        var latScale = d3.scale.linear()
            .domain([-90,90]).range([context.height,0]);
        var lonScale = d3.scale.linear()
            .domain([-180,180]).range([0,context.width]);
        data.forEach(function(city){
            context.lineTo(lonScale(city.lon), latScale(city.lat));
        });
        context.lineWidth = 20;
        context.strokeStyle= "#f00";
        context.stroke();
    });
    */        
});

</script>


</body>
</html>
