<!DOCTYPE html>
<html>
<head>
    <title>D3GL Earth Climate</title>
    <link rel="stylesheet" href="../css/demo.css" />
</head>
<body>

<h1>Rainfall</h1>
<ul id="picker">
</ul>

<script type="text/javascript" src="../js/jquery-1.8.2.js"></script>
<script type="text/javascript" src="../js/jquery.mousewheel.js"></script>
<script type="text/javascript" src="../js/d3.v2.js"></script>
<script type="text/javascript" src="../js/RequestAnimationFrame.js"></script>
<script type="text/javascript" src="../js/three.js"></script>
<script type="text/javascript" src="../js/d3gl.js"></script>
<!-- All scripts above are included here:
<script type="text/javascript" src="../js/d3gl.min.js"></script> -->
<script type="text/javascript" src="../data/country_code_map.js"></script>

<script type="text/javascript">
var climateDataTypes = ["pr", "tas"];
var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
function createControls(){
    var selected;
    d3.select("#picker").selectAll("li")
        .data(months)
        .enter().append("li")
            .text(function(d){ return d; })
            .attr("id", function(d, i) { return i; })
            .on('click', function(d) { 
                console.log(d); 
                if(selected) $(selected).removeClass("selected");
                $(selected = this).addClass("selected");
            });
}

function getDataDomain(data) {
    var min = null, max = null;
    data.forEach(function(elem) {
        elem["monthly_data"].forEach(function(datum) {
            var val = datum["data"];
            if(!min || !max) {
                min = max = val;
            } else if(val < min) {
                min = val;
            } else if(val > max) {
                max = val;
            }
        });
    });
    return [min, max];
}

$(function(){
    // create the ui
    createControls();

    var data = {};
    var nLoaded = 0;
    d3.json("../data/pr.json", function(datum){
        var domain = getDataDomain(datum);
        data["pr"] = {};
        data["pr"].sr = d3.scale.linear()
            .domain(domain)
            .range([255, 0]);
        data["pr"].sg = d3.scale.linear()
            .domain(domain)
            .range([234, 153]);
        data["pr"].sb = d3.scale.linear()
            .domain(domain)
            .range([153, 51]);
        data["pr"].data = datum;
        if(++nLoaded==2) {
            createGlobes(data);
        }
    });
    d3.json("../data/tas.json", function(datum){
        var domain = getDataDomain(datum);
        data["tas"] = {};
        data["tas"].sr = d3.scale.linear()
            .domain(domain)
            .range([255, 0]);
        data["tas"].sg = d3.scale.linear()
            .domain(domain)
            .range([234, 153]);
        data["tas"].sb = d3.scale.linear()
            .domain(domain)
            .range([153, 51]);
        data["tas"].data = datum;
        if(++nLoaded==2) {
            createGlobes(data);
        }
    });
});

function createGlobes(data) {
    // create the globe
    var globe = d3.gl.globe()
        .width(400).height(400)
        .texture("../img/earth-blank.png")
        .transparency(function(body){
            return 0.96;
        });

    var mouseoverPoint;
    globe.shapes("countries")
        .data(function(climateDataT) {
            return data[climateDataT]["data"];
        })
        .id(function(d){
            // the id returned here must match the color in the shape texture
            // such that r*10*10 + g*10 + b = id
            return country_code_map["alpha_code_to_country"][d["ISO_code"]]["country-code"];
        })
        .color(function(d){
            if(d==mouseoverPoint) return [255, 153, 153, 255];
            var values = d["monthly_data"];
            if(values.length>0) {
                var idx = $(".selected").length ? $(".selected").attr("id") : 0;
                var value = parseInt(d["monthly_data"][idx]["data"]);
                return [
                    data[d["var"]].sr(value),
                    data[d["var"]].sg(value),
                    data[d["var"]].sb(value),
                    255
                ];
            }
            return [0, 0, 0, 0];
        })
        .on("mousemove", function(evt) {
            if(evt.shape) {
                mouseoverPoint = evt.shape;
            } else {
                mouseoverPoint = null;
            }
        })
        .on("click", function(evt) {
            if(evt.shape) {
                showDetails(evt, evt.shape);
            } else {
                $("#bubble").hide();
            }
        });

    d3.select("body").selectAll("span")
        .data(climateDataTypes)
        .enter()
        .append("span")
        .call(globe);
}

function showDetails(mouseEvent, data) {
    var name = country_code_map["alpha_code_to_country"][data["ISO_code"]]["name"];
    var idx = $(".selected").length ? $(".selected").attr("id") : 0;
    var value = data["monthly_data"].length==0 ? "N/A" : data["monthly_data"][idx]["data"];
    var size = name.length > 15 ? "10pt" : "12pt";
    var height = name.length > 15 ? 60 : 40;
    $("#bubble").show()
        .css("font-size", size)
        .css("height", height + "px")
        .css("left", mouseEvent.clientX)
        .css("top", mouseEvent.clientY + height/3)
        .html(name + "<br />" + value + (data["var"]=="pr" ? " mm" : " &deg;C"));
}

</script>
<div id="bubble"></div>
</body>
</html>
